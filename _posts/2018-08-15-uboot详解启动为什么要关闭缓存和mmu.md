---
layout:     post   				 # 使用的布局（不需要改）
title:      uboot详解 	         # 标题 
subtitle:   				 #副标题
date:       2018-08-15 				 # 时间
author:     咖啡泡泡茶 			    # 作者
header-img: img/post-bg-coffee.jpg 	         #这篇文章标题背景图片
catalog: true 					 # 是否归档
tags:					         #标签
    - 
---

### uboot详解—为什么要关闭缓存和mmu

​	当设置完时钟分频以后，uboot就会执行cpu_init_crit汇编函数，这个函数的主要作用就是关闭缓存和mmu，然后调用lowlevel_init函数进行系统总线的初始化。

​	为什么启动的时候，需要关闭缓存和mmu呢？我们先了解一下他们的作用。

​	缓存是主存(内存)和CPU通用寄存器之间设置的一个高速的、容量相对较小的存储器，把正在执行的指令地址附近的一部分指令或数据从主存调入这个存储器，供CPU在一段时间内使用，以提高程序的运行速度。

​	mmu可以实现虚拟内存和内存保护等功能，完成对内存的操作和管理。
CACHE是高速缓冲存储器。CPU工作速度是很快的，而外部内存是工作很慢的，所以当CPU对内存访问的时候，是要等待内存访问结束的。所以中间CPU就在等待，这就浪费了时间。所以在CPU和内存之间加一个CACHE，当CPU写数据到内存中的时候，就先写入到CACHE中，然后CACHE再写入到内存中。CPU写CACHE是很快的，所以就提高了写数据的效率。读数据的话，CPU先在CACHE中去找数据，没有找到的话，CACHE将数据从内存中取出来，再给CPU，同时把这个数据存起来。当CPU在CACHE中找到数据的话，就直接使用这个数据，就不用再去内存中取数据了。

​	Caches是CPU内部的一个2级缓存，它的作用是将常用的数据和指令放在CPU内部。Caches是通过CP15管理的，刚上电的时候，CPU还不能管理Caches。上电的时候指令Cache可关闭，也可不关闭，但数据Cache一定要关闭，否则可能导致刚开始的代码里面，去取数据的时候，从Cache里面取，而这时候RAM中数据还没有Cache过来，导致数据预取异常 。说到Caches就必须提到一个关键字Volatile，它的本质：是告诉编译器不要对我的代码进行优化，作用是让编写者感觉变量的变化情况。因为在优化时，会将常用的代码取出来放到Caches中，它没有从实际的物理地址去取，它直接从CPU的缓存中去取，但常用的代码就是为了检测一些常用变量的变化，如果正在取数据的时候发生跳变，那么就检测不到变量的变化了，所以在这种情况下要用Volatile关键字告诉编译器不要做优化，让cpu每次都从实际的物理地址中去取指令。其实这也是为什么要关闭数据缓存的原因，如果汇编指令读取的时候缓存中的数据，而实际物理地址的数据发生了变化，将导致cpu读取不到真实的最新的值。然而在C语言中是不会关闭Caches的，如果编写者要检测外界物理数据的变化，或变化太快，从Caches中取数据会有误差，就加一个关键字Volatile。

​	同样，在板子启动的时候是没有对mmu进行初始化的，而且这个时候也用不到mmu，为了避免他们影响启动时的初始化，所以需要先关闭mmu和缓存。

![](http://wx1.sinaimg.cn/mw690/b00a7483gy1fuahlpf05gj20ha0h0gnb.jpg)
